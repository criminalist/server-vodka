<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:title" content="Vodka - Fast and unfancy HTTP server framework for Go (Golang)">
        <meta property="og:site_name" content="vodka">
        <meta property="og:og:description" content="">
        <title>
  Google App Engine Recipe | Vodka - Fast and unfancy HTTP server framework for Go (Golang)
        </title>
        <link rel="stylesheet" href="../../styles/doc.css">
    </head>
<body>
	<nav class="navbar">
  <a href="../../index.html"><img class="logo" src="../../images/logo.png" alt="Vodka"></a>
  <span class="w3-hide-small w3-hide-medium">
    <input id="search-box" type="text" class="w3-input" placeholder="Search...">
    <i class="fa fa-search"></i>
  </span>
  <a class="github-button" href="https://github.com/insionng/vodka" data-icon="octicon-star" data-style="mega" data-count-href="../../insionng/vodka/stargazers/index.html" data-count-api="/repos/insionng/vodka#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star insionng/vodka on GitHub">
    Star
  </a>
  <span class="w3-xxlarge w3-hide-large" onclick="openSidenav()">&#9776;</span>
</nav>

	<nav id="sidenav" class="w3-sidenav w3-collapse w3-animate-left">
  <span class="w3-closenav w3-xxlarge w3-hide-large" onclick="closeSidenav()">
    &times;
  </span>
  <a class="support w3-btn w3-white w3-border w3-border-theme w3-round-xlarge" href="https://github.com/vodka-contrib">
     Vodka Contrib
  </a>
  
  
    <h4><i class='fa fa-book'></i> Guide</h4>
      
        <a href="../../guide/installation/index.html">
          Installation
        </a>
        
      
        <a href="../../guide/migrating/index.html">
          Migrating
        </a>
        
      
        <a href="../../guide/customization/index.html">
          Customization
        </a>
        
      
        <a href="../../guide/static-files/index.html">
          Static Files
        </a>
        
      
        <a href="../../guide/templates/index.html">
          Templates
        </a>
        
      
        <a href="../../guide/routing/index.html">
          Routing
        </a>
        
      
        <a href="../../guide/context/index.html">
          Context
        </a>
        
      
        <a href="../../guide/cookies/index.html">
          Cookies
        </a>
        
      
        <a href="../../guide/request/index.html">
          Request
        </a>
        
      
        <a href="../../guide/error-handling/index.html">
          Error Handling
        </a>
        
      
        <a href="../../guide/testing/index.html">
          Testing
        </a>
        
      
        <a href="../../guide/faq/index.html">
          FAQ
        </a>
        
      
  
    <h4><i class='fa fa-filter'></i> Middleware</h4>
      
        <a href="../../middleware/overview/index.html">
          Overview
        </a>
        
      
        <a href="../../middleware/basic-auth/index.html">
          BasicAuth
        </a>
        
      
        <a href="../../middleware/body-limit/index.html">
          BodyLimit
        </a>
        
      
        <a href="../../middleware/cors/index.html">
          CORS
        </a>
        
      
        <a href="../../middleware/csrf/index.html">
          CSRF
        </a>
        
      
        <a href="../../middleware/gzip/index.html">
          Gzip
        </a>
        
      
        <a href="../../middleware/jwt/index.html">
          JWT
        </a>
        
      
        <a href="../../middleware/logger/index.html">
          Logger
        </a>
        
      
        <a href="../../middleware/method-override/index.html">
          MethodOverride
        </a>
        
      
        <a href="../../middleware/recover/index.html">
          Recover
        </a>
        
      
        <a href="../../middleware/redirect/index.html">
          Redirect
        </a>
        
      
        <a href="../../middleware/secure/index.html">
          Secure
        </a>
        
      
        <a href="../../middleware/static/index.html">
          Static
        </a>
        
      
        <a href="../../middleware/trailing-slash/index.html">
          TrailingSlash
        </a>
        
      
  
    <h4><i class='fa fa-code'></i> Recipes</h4>
      
        <a href="../hello-world/index.html">
          Hello World
        </a>
        
      
        <a href="../crud/index.html">
          CRUD
        </a>
        
      
        <a href="../cors/index.html">
          CORS
        </a>
        
      
        <a href="../http2/index.html">
          HTTP/2
        </a>
        
      
        <a href="../middleware/index.html">
          Middleware
        </a>
        
      
        <a href="../streaming-response/index.html">
          Streaming Response
        </a>
        
      
        <a href="../websocket/index.html">
          WebSocket
        </a>
        
      
        <a href="../jsonp/index.html">
          JSONP
        </a>
        
      
        <a href="../file-upload/index.html">
          File Upload
        </a>
        
      
        <a href="../subdomains/index.html">
          Subdomains
        </a>
        
      
        <a href="../jwt/index.html">
          JWT
        </a>
        
      
        <a class="active" href="#">
          Google App Engine
        </a>
        
      
        <a href="../graceful-shutdown/index.html">
          Graceful Shutdown
        </a>
        
      
        <a href="../embed-resources/index.html">
          Embed Resources
        </a>
        
      
  
    <h4><i class='fa fa-file-text-o'></i> Godoc</h4>
      
        <a href="https://godoc.org/github.com/insionng/vodka">
          vodka
        </a>
        
      
        <a href="https://godoc.org/github.com/insionng/vodka/middleware">
          middleware
        </a>
        
      
        <a href="https://godoc.org/github.com/insionng/vodka/engine">
          engine
        </a>
        
      
        <a href="https://godoc.org/github.com/insionng/vodka/engine/standard">
          engine/standard
        </a>
        
      
        <a href="https://godoc.org/github.com/insionng/vodka/engine/fasthttp">
          engine/fasthttp
        </a>
        
      
  
</nav>

	<div id="search-menu"></div>

	<div class="w3-main w3-padding-128">
		<div class="ad">
  <script async type="text/javascript" src="https://cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=vodkainsionngcom" id="_carbonads_js"></script>
</div>


	  <div class="w3-row-padding">
			<div class="w3-col m9 l9">
				<div class="w3-panel w3-red notice">
  <h3>
    YOUGAM V4 WILL USE <a href="https://github.com/insionng/vodka">VODKA V2</a>
  </h3>
  <p>
    Vodka是一个强大Go语言中间件式的模块化web框架，是基于Echo二次开发的加强版本
  </p>
</div>

        <article class="content">
          <section>
            

<h2 id="google-app-engine-recipe">Google App Engine Recipe</h2>

<p>Google App Engine (GAE) provides a range of hosting options from pure PaaS (App Engine Classic)
through Managed VMs to fully self-managed or container-driven Compute Engine instances. Vodka
works great with all of these but requires a few changes to the usual examples to run on the
AppEngine Classic and Managed VM options. With a small amount of effort though it&rsquo;s possible
to produce a codebase that will run on these and also non-managed platforms automatically.</p>

<p>We&rsquo;ll walk through the changes needed to support each option.</p>

<h3 id="standalone">Standalone</h3>

<p>Wait? What? I thought this was about AppEngine! Bear with me - the easiest way to show the changes
required is to start with a setup for standalone and work from there plus there&rsquo;s no reason we
wouldn&rsquo;t want to retain the ability to run our app anywhere, right?</p>

<p>We take advantage of the go <a href="http://golang.org/pkg/go/build/">build constraints or tags</a> to change
how we create and run the Vodka server for each platform while keeping the rest of the application
(e.g. handler wireup) the same across all of them.</p>

<p>First, we have the normal setup based on the examples but we split it into two files - <code>app.go</code> will
be common to all variations and holds the Vodka instance variable. We initialise it from a function
and because it is a <code>var</code> this will happen <em>before</em> any <code>init()</code> functions run - a feature that we&rsquo;ll
use to connect our handlers later.</p>

<p><code>app.go</code></p>

<pre><code class="language-go">package main

// reference our vodka instance and create it early
var e = createMux()
</code></pre>


<p>A separate source file contains the function to create the Vodka instance and add the static
file handlers and middleware. Note the build tag on the first line which says to use this when <em>not</em>
bulding with appengine or appenginevm tags (which thoese platforms automatically add for us). We also
have the <code>main()</code> function to start serving our app as normal. This should all be very familiar.</p>

<p><code>app-standalone.go</code></p>

<pre><code class="language-go">
// +build !appengine,!appenginevm

package main

import (
	"github.com/insionng/vodka"
	"github.com/insionng/vodka/engine/standard"
	"github.com/insionng/vodka/middleware"
)

func createMux() *vodka.Vodka {
	e := vodka.New()

	e.Use(middleware.Recover())
	e.Use(middleware.Logger())
	e.Use(middleware.Gzip())

	e.Use(middleware.Static("public"))

	return e
}

func main() {
	e.Run(standard.New(":8080"))
}
</code></pre>


<p>The handler-wireup that would normally also be a part of this Vodka setup moves to separate files which
take advantage of the ability to have multiple <code>init()</code> functions which run <em>after</em> the <code>e</code> Vodka var is
initialised but <em>before</em> the <code>main()</code> function is executed. These allow additional handlers to attach
themselves to the instance - I&rsquo;ve found the <code>Group</code> feature naturally fits into this pattern with a file
per REST endpoint, often with a higher-level <code>api</code> group created that they attach to instead of the root
Vodka instance directly (so things like CORS middleware can be added at this higher common-level).</p>

<p><code>users.go</code></p>

<pre><code class="language-go">
package main

import (
	"net/http"

	"github.com/insionng/vodka"
	"github.com/insionng/vodka/middleware"
)

type (
	user struct {
		ID   string `json:"id"`
		Name string `json:"name"`
	}
)

var (
	users map[string]user
)

func init() {
	users = map[string]user{
		"1": user{
			ID:   "1",
			Name: "Wreck-It Ralph",
		},
	}

	// hook into the vodka instance to create an endpoint group
	// and add specific middleware to it plus handlers
	g := e.Group("/users")
	g.Use(middleware.CORS())

	g.POST("", createUser)
	g.GET("", getUsers)
	g.GET("/:id", getUser)
}

func createUser(c vodka.Context) error {
	u := new(user)
	if err := c.Bind(u); err != nil {
		return err
	}
	users[u.ID] = *u
	return c.JSON(http.StatusCreated, u)
}

func getUsers(c vodka.Context) error {
	return c.JSON(http.StatusOK, users)
}

func getUser(c vodka.Context) error {
	return c.JSON(http.StatusOK, users[c.P(0)])
}
</code></pre>


<p>If we run our app it should execute as it did before when everything was in one file although we have
at least gained the ability to organize our handlers a little more cleanly.</p>

<h3 id="appengine-classic-and-managed-vms">AppEngine Classic and Managed VMs</h3>

<p>So far we&rsquo;ve seen how to split apart the Vodka creation and setup but still have the same app that
still only runs standalone. Now we&rsquo;ll see hwo those changes allow us to add support for AppEngine
hosting.</p>

<p>Refer to the <a href="https://cloud.google.com/appengine/docs/go/">AppEngine site</a> for full configuration
and deployment information.</p>

<h4 id="app-yaml-configuration-file">app.yaml configuration file</h4>

<p>Both of these are Platform as as Service options running on either sandboxed micro-containers
or managed Compute Engine instances. Both require an <code>app.yaml</code> file to describe the app to
the service. While the app <em>could</em> still serve all it&rsquo;s static files itself, one of the benefits
of the platform is having Google&rsquo;s infrastructure handle that for us so it can be offloaded and
the app only has to deal with dynamic requests. The platform also handles logging and http gzip
compression so these can be removed from the codebase as well.</p>

<p>The yaml file also contains other options to control instance size and auto-scaling so for true
deployment freedom you would likely have separate <code>app-classic.yaml</code> and <code>app-vm.yaml</code> files and
this can help when making the transition from AppEngine Classic to Managed VMs.</p>

<p><code>app-engine.yaml</code></p>

<pre><code class="language-yaml">
application: my-application-id  # defined when you create your app using google dev console
module: default                 # see https://cloud.google.com/appengine/docs/go/
version: alpha                  # you can run multiple versions of an app and A/B test
runtime: go                     # see https://cloud.google.com/appengine/docs/go/
api_version: go1                # used when appengine supports different go versions

default_expiration: "1d"        # for CDN serving of static files (use url versioning if long!)

handlers:
# all the static files that we normally serve ourselves are defined here and Google will handle
# serving them for us from it's own CDN / edge locations. For all the configuration options see:
# https://cloud.google.com/appengine/docs/go/config/appconfig#Go_app_yaml_Static_file_handlers
- url: /
  mime_type: text/html
  static_files: public/index.html
  upload: public/index.html

- url: /favicon.ico
  mime_type: image/x-icon
  static_files: public/favicon.ico
  upload: public/favicon.ico

- url: /scripts
  mime_type: text/javascript
  static_dir: public/scripts

# static files normally don't touch the server that the app runs on but server-side template files
# needs to be readable by the app. The application_readable option makes sure they are available as
# part of the app deployment onto the instance.
- url: /templates
  static_dir: /templates
  application_readable: true

# finally, we route all other requests to our application. The script name just means "the go app"
- url: /.*
  script: _go_app
</code></pre>


<h4 id="router-configuration">Router configuration</h4>

<p>We&rsquo;ll now use the <a href="http://golang.org/pkg/go/build/">build constraints</a> again like we did when creating
our <code>app-standalone.go</code> instance but this time with the opposite tags to use this file <em>if</em> the build has
the appengine or appenginevm tags (added automatically when deploying to these platforms).</p>

<p>This allows us to replace the <code>createMux()</code> function to create our Vodka server <em>without</em> any of the
static file handling and logging + gzip middleware which is no longer required. Also worth nothing is
that GAE classic provides a wrapper to handle serving the app so instead of a <code>main()</code> function where
we run the server, we instead wire up the router to the default <code>http.Handler</code> instead.</p>

<p><code>app-engine.go</code></p>

<pre><code class="language-go">
// +build appengine

package main

import (
	"github.com/insionng/vodka"
	"github.com/insionng/vodka/engine/standard"
	"net/http"
)

func createMux() *vodka.Vodka {
	e := vodka.New()

	// note: we don't need to provide the middleware or static handlers, that's taken care of by the platform
	// app engine has it's own "main" wrapper - we just need to hook vodka into the default handler
	s := standard.New("")
	s.SetHandler(e)
	http.Handle("/", s)

	return e
}
</code></pre>


<p>Managed VMs are slightly different. They are expected to respond to requests on port 8080 as well
as special health-check requests used by the service to detect if an instance is still running in
order to provide automated failover and instance replacement. The <code>google.golang.org/appengine</code>
package provides this for us so we have a slightly different version for Managed VMs:</p>

<p><code>app-managed.go</code></p>

<pre><code class="language-go">
// +build appenginevm

package main

import (
	"github.com/insionng/vodka"
	"github.com/insionng/vodka/engine/standard"
	"google.golang.org/appengine"
	"net/http"
	"runtime"
)

func createMux() *vodka.Vodka {
	e := vodka.New()

	// note: we don't need to provide the middleware or static handlers
	// for the appengine vm version - that's taken care of by the platform

	return e
}

func main() {
	// the appengine package provides a convenient method to handle the health-check requests
	// and also run the app on the correct port. We just need to add Vodka to the default handler
	s := standard.New(":8080")
	s.SetHandler(e)
	http.Handle("/", s)
	appengine.Main()
}
</code></pre>


<p>So now we have three different configurations. We can build and run our app as normal so it can
be executed locally, on a full Compute Engine instance or any other traditional hosting provider
(including EC2, Docker etc&hellip;). This build will ignore the code in appengine and appenginevm tagged
files and the <code>app.yaml</code> file is meaningless to anything other than the AppEngine platform.</p>

<p>We can also run locally using the <a href="https://cloud.google.com/appengine/downloads">Google AppEngine SDK for Go</a>
either emulating <a href="https://cloud.google.com/appengine/docs/go/tools/devserver">AppEngine Classic</a>:</p>

<pre><code>goapp serve
</code></pre>

<p>Or <a href="https://cloud.google.com/appengine/docs/managed-vms/sdk#run-local">Managed VMs</a>:</p>

<pre><code>gcloud config set project [your project id]
gcloud preview app run .
</code></pre>

<p>And of course we can deploy our app to both of these platforms for easy and inexpensive auto-scaling joy.</p>

<p>Depending on what your app actually does it&rsquo;s possible you may need to make other changes to allow
switching between AppEngine provided service such as Datastore and alternative storage implementations
such as MongoDB. A combination of go interfaces and build constraints can make this fairly straightforward
but is outside the scope of this recipe.</p>

<h3 id="maintainers">Maintainers</h3>

<ul>
<li><a href="https://github.com/CaptainCodeman">CaptainCodeman</a></li>
</ul>

<h3 id="source-code-hahahugoshortcode-7hbhb"><a href="https://github.com/insionng/vodkax/tree/master/recipe/google-app-engine
">Source Code</a></h3>

          </section>
          <footer style="margin-top: 40px;">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               
              var disqus_shortname = 'insionng';

               
              (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
          </footer>
        </article>
			</div>
	  </div>
	</div>
	<footer class="w3-container w3-padding-48 w3-center footer">
  <p>
    <strong>Vodka</strong> by <a href="https://insionng.com">InsionNg</a> © 2016 InsionNg. All Rights Reserved.
  </p>
  <p>
    <a class="icon" href="https://blog.insionng.com">
      <i class="fa fa-rss" aria-hidden="true"></i>
    </a>
    <a class="icon" href="https://github.com/insionng">
      <i class="fa fa-github" aria-hidden="true"></i>
    </a>
    <a class="icon" href="https://facebook.com/insionng">
      <i class="fa fa-facebook" aria-hidden="true"></i>
    </a>
    <a class="icon" href="https://twitter.com/insionng">
      <i class="fa fa-twitter" aria-hidden="true"></i>
    </a>
    <a class="icon" href="https://plus.google.com/+insionng">
      <i class="fa fa-google-plus" aria-hidden="true"></i>
    </a>
  </p>
</footer>
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
<script type="text/javascript">
  docsearch({
    apiKey: '69dfc65b57ccba29ec34b68aa5b274ed',
    indexName: 'insionng',
    inputSelector: '#search-box',
    autocompleteOptions: {
      dropdownMenuContainer: '#search-menu'
    }
  });
</script>

<script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-85059636-2', 'auto');
ga('send', 'pageview');
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>

<script src="../../scripts/prism.js"></script>
<script src="../../scripts/vodka.js"></script>

</body>
</html>
